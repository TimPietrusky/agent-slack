name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:
          - os: darwin
            runner: macos-latest
            targets: |
              bun-darwin-arm64:agent-slack-darwin-arm64
              bun-darwin-x64:agent-slack-darwin-x64
          - os: linux
            runner: ubuntu-latest
            targets: |
              bun-linux-x64:agent-slack-linux-x64
              bun-linux-x64-musl:agent-slack-linux-x64-musl
              bun-linux-arm64:agent-slack-linux-arm64
              bun-linux-arm64-musl:agent-slack-linux-arm64-musl
          - os: windows
            runner: windows-latest
            targets: |
              bun-windows-x64:agent-slack-windows-x64.exe
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Lint
        if: matrix.os == 'linux'
        run: bun run lint

      - name: Test
        if: matrix.os == 'linux'
        run: bun run test

      - name: Build binaries
        shell: bash
        run: |
          mkdir -p release
          echo "${{ matrix.targets }}" | while IFS=: read -r target outfile; do
            [ -z "$target" ] && continue
            echo "Building $outfile ($target)"
            bun build src/index.ts --compile --target="$target" --outfile="release/$outfile"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.os }}
          path: release/

  release:
    name: Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd release
          sha256sum agent-slack-* > checksums-sha256.txt

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release/agent-slack-*
            release/checksums-sha256.txt
          generate_release_notes: true
